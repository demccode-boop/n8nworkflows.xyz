{"name":"AI Nutritionist: BP Meal Planner (Fixed Layout)","nodes":[{"id":"sticky-collection","name":"Sticky Note Collection","type":"n8n-nodes-base.stickyNote","position":[-1552,-80],"parameters":{"color":7,"width":860,"height":340,"content":"## 1. Data Collection\nFetches weekly blood pressure data from Google Sheets and calculates the average status (High/Normal/Optimal)."},"typeVersion":1},{"id":"sticky-strategy","name":"Sticky Note Strategy","type":"n8n-nodes-base.stickyNote","position":[-624,-80],"parameters":{"color":7,"width":300,"height":340,"content":"## 2. AI Strategy\n**Gemini (1.5-flash)** analyzes the health status to decide the best search query (e.g., \"Low sodium recipes\")."},"typeVersion":1},{"id":"sticky-execution","name":"Sticky Note Execution","type":"n8n-nodes-base.stickyNote","position":[-304,-80],"parameters":{"color":7,"width":420,"height":340,"content":"## 3. Parallel Execution\nSimultaneously searches for real recipes on Google and generates a BP trend chart via QuickChart.io."},"typeVersion":1},{"id":"sticky-report","name":"Sticky Note Report","type":"n8n-nodes-base.stickyNote","position":[176,-80],"parameters":{"color":7,"width":700,"height":340,"content":"## 4. Synthesis & Report\n**Gemini** creates a personalized meal plan based on the search results and sends an email with the chart attached."},"typeVersion":1},{"id":"schedule-trigger","name":"Weekly Schedule (Mon 7AM)","type":"n8n-nodes-base.scheduleTrigger","position":[-1504,64],"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[1],"triggerAtHour":7}]}},"typeVersion":1.2},{"id":"config","name":"Workflow Configuration","type":"n8n-nodes-base.set","position":[-1296,64],"parameters":{"options":{},"assignments":{"assignments":[{"id":"id-1","name":"spreadsheetId","type":"string","value":"<__PLACEHOLDER_VALUE__Google Spreadsheet ID__>"},{"id":"id-2","name":"sheetName","type":"string","value":"<__PLACEHOLDER_VALUE__Sheet Name__>"},{"id":"id-3","name":"googleSearchApiKey","type":"string","value":"<__PLACEHOLDER_VALUE__Google Custom Search API Key__>"},{"id":"id-4","name":"googleSearchEngineId","type":"string","value":"<__PLACEHOLDER_VALUE__Search Engine ID__>"}]},"includeOtherFields":true},"typeVersion":3.4},{"id":"get-bp-data","name":"Get Blood Pressure Data","type":"n8n-nodes-base.googleSheets","position":[-1072,64],"parameters":{"options":{},"resource":"spreadsheet"},"credentials":{"googleSheetsOAuth2Api":{"id":"credential-id","name":"googleSheetsOAuth2Api Credential"}},"typeVersion":4.7},{"id":"calc-averages","name":"Calculate Averages","type":"n8n-nodes-base.code","position":[-848,64],"parameters":{"jsCode":"// Calculate averages for the last 7 days\nconst items = $input.all();\nconst sevenDaysAgo = new Date();\nsevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n\nconst recentData = items.filter(item => {\n  const entryDate = new Date(item.json.date);\n  return entryDate >= sevenDaysAgo;\n});\n\nlet totalSystolic = 0;\nlet totalDiastolic = 0;\nconst dataCount = recentData.length;\n\nrecentData.forEach(item => {\n  totalSystolic += parseFloat(item.json.systolic || 0);\n  totalDiastolic += parseFloat(item.json.diastolic || 0);\n});\n\nconst avgSystolic = dataCount > 0 ? Math.round(totalSystolic / dataCount) : 0;\nconst avgDiastolic = dataCount > 0 ? Math.round(totalDiastolic / dataCount) : 0;\n\n// Determine Status for Logic\nlet status = 'Normal';\nif (avgSystolic > 130 || avgDiastolic > 80) status = 'High';\nif (avgSystolic < 120 && avgDiastolic < 80) status = 'Optimal';\n\nreturn [\n  {\n    json: {\n      avgSystolic,\n      avgDiastolic,\n      dataCount,\n      status,\n      rawData: recentData.map(item => item.json)\n    }\n  }\n];"},"typeVersion":2},{"id":"google-search","name":"Google Custom Search","type":"n8n-nodes-base.httpRequest","position":[-272,-20],"parameters":{"url":"https://www.googleapis.com/customsearch/v1","options":{},"sendQuery":true,"queryParameters":{"parameters":[{"name":"key","value":"={{ $('Workflow Configuration').first().json.googleSearchApiKey }}"},{"name":"cx","value":"={{ $('Workflow Configuration').first().json.googleSearchEngineId }}"},{"name":"q","value":"={{ $json.content.parts[0].text }} site:cookpad.com OR site:recipe.rakuten.co.jp"},{"name":"num","value":"5"}]}},"typeVersion":4.3},{"id":"gen-chart-config","name":"Generate Chart Config","type":"n8n-nodes-base.code","position":[-272,176],"parameters":{"jsCode":"// Generate Chart Config\nconst rawData = $('Calculate Averages').first().json.rawData;\n\nconst labels = rawData.map(item => {\n  const d = new Date(item.date);\n  return `${d.getMonth() + 1}/${d.getDate()}`;\n});\nconst systolic = rawData.map(item => item.systolic);\nconst diastolic = rawData.map(item => item.diastolic);\n\nconst chartConfig = {\n  type: 'line',\n  data: {\n    labels: labels,\n    datasets: [\n      { label: 'Systolic', data: systolic, borderColor: 'rgb(255, 99, 132)', fill: false },\n      { label: 'Diastolic', data: diastolic, borderColor: 'rgb(54, 162, 235)', fill: false }\n    ]\n  }\n};\n\nconst chartUrl = `https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(chartConfig))}`;\nreturn { json: { chartUrl } };"},"typeVersion":2},{"id":"download-chart","name":"Download Chart Image","type":"n8n-nodes-base.httpRequest","position":[-64,176],"parameters":{"url":"={{ $json.chartUrl }}","options":{"response":{"response":{"responseFormat":"file"}}}},"typeVersion":4.3},{"id":"merge","name":"Merge Search & Chart","type":"n8n-nodes-base.merge","position":[224,64],"parameters":{},"typeVersion":3},{"id":"send-email","name":"Send Email Report","type":"n8n-nodes-base.gmail","position":[672,64],"parameters":{"sendTo":"<__PLACEHOLDER_VALUE__Recipient Email__>","message":"={{ $json.content.parts[0].text }}","options":{},"subject":"={{ $('Calculate Averages').first().json.status === 'High' ? '⚠️ High BP Alert: ' : '' }}Weekly Meal Plan & Health Report","emailType":"text"},"credentials":{"gmailOAuth2":{"id":"credential-id","name":"gmailOAuth2 Credential"}},"typeVersion":2.1},{"id":"gemini-decide","name":"Message a model","type":"@n8n/n8n-nodes-langchain.googleGemini","position":[-608,64],"parameters":{"modelId":{"__rl":true,"mode":"list","value":"models/gemini-1.5-flash","cachedResultName":"models/gemini-1.5-flash"},"options":{},"messages":{"values":[{"content":"=You are a nutritionist assistant.\n\nUser Data:\n- Avg Systolic: {{ $json.avgSystolic }}\n- Avg Diastolic: {{ $json.avgDiastolic }}\n- Status: {{ $json.status }}\n\nTask:\nBased on this blood pressure status, generate a specific search query (in Japanese) to find suitable dinner recipes on Google.\n\nExamples:\n- If High: \"減塩 夕食 レシピ\"\n- If Normal: \"バランスの良い 夕食 レシピ\"\n\nOutput ONLY the search query string."}]}},"credentials":{"googlePalmApi":{"id":"credential-id","name":"googlePalmApi Credential"}},"typeVersion":1},{"id":"gemini-report","name":"Message a model2","type":"@n8n/n8n-nodes-langchain.googleGemini","position":[432,64],"parameters":{"modelId":{"__rl":true,"mode":"list","value":"models/gemini-1.5-flash","cachedResultName":"models/gemini-1.5-flash"},"options":{},"messages":{"values":[{"content":"==あなたはプロの管理栄養士です。\n\n【ユーザーの健康データ】\n{{ JSON.stringify($('Calculate Averages').first().json) }}\n\n【検索されたレシピ候補】\n{{ JSON.stringify($('Google Custom Search').all().map(i => i.json)) }}\n\n【タスク】\nユーザーの血圧状態（High/Normal/Optimal）に基づいて、月曜日から金曜日までの5日間の夕食の献立を作成してください。\n提供されたレシピ候補の中から、ユーザーの健康状態に適したものを選び、必ずURLを添えてください。\n\n【出力形式（日本語）】\n1. 今週の血圧傾向とアドバイス\n2. 5日間の献立（料理名とURL）\n3. 今週の食事のポイント"}]}},"credentials":{"googlePalmApi":{"id":"credential-id","name":"googlePalmApi Credential"}},"executeOnce":true,"typeVersion":1},{"id":"sticky-main","name":"Sticky Note Main","type":"n8n-nodes-base.stickyNote","position":[-2128,-144],"parameters":{"width":550,"height":650,"content":"# AI Nutritionist: BP Meal Planner\n\n## Overview\n**AI Health Assistant powered by Gemini.**\nManages blood pressure by analyzing data, deciding dietary strategies, and planning meals with real recipes.\n\n## Workflow Steps\n1. **Analyze:** Calculates weekly BP averages from Google Sheets.\n2. **Decide:** Gemini determines the best recipe search keywords based on BP status.\n3. **Search & Chart:** Fetches recipes (Google Search) and creates a trend chart (QuickChart) in parallel.\n4. **Report:** Gemini creates a meal plan and sends an email with the chart.\n\n## Setup\n1. **Sheets:** Create columns: `date`, `systolic`, `diastolic`.\n2. **Config:** Open **\"Workflow Configuration\"** to set IDs and Keys.\n3. **Email:** Set the recipient in the \"Send Email Report\" node.\n\n## Requirements\n- Google Gemini API\n- Google Custom Search API\n- Google Sheets & Gmail"},"typeVersion":1}],"pinData":{},"connections":{"Message a model":{"main":[[{"node":"Google Custom Search","type":"main","index":0}]]},"Message a model2":{"main":[[{"node":"Send Email Report","type":"main","index":0}]]},"Calculate Averages":{"main":[[{"node":"Message a model","type":"main","index":0},{"node":"Generate Chart Config","type":"main","index":0}]]},"Download Chart Image":{"main":[[{"node":"Merge Search & Chart","type":"main","index":1}]]},"Google Custom Search":{"main":[[{"node":"Merge Search & Chart","type":"main","index":0}]]},"Merge Search & Chart":{"main":[[{"node":"Message a model2","type":"main","index":0}]]},"Generate Chart Config":{"main":[[{"node":"Download Chart Image","type":"main","index":0}]]},"Workflow Configuration":{"main":[[{"node":"Get Blood Pressure Data","type":"main","index":0}]]},"Get Blood Pressure Data":{"main":[[{"node":"Calculate Averages","type":"main","index":0}]]},"Weekly Schedule (Mon 7AM)":{"main":[[{"node":"Workflow Configuration","type":"main","index":0}]]}}}